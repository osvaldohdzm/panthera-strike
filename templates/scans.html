<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panthera Scanner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&family=Ubuntu:wght@400;500;700&family=Ubuntu+Mono:wght@400;700&family=Source+Code+Pro:wght@400;500&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/scanner_styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script>
        const SCRIPT_ROOT = "{{ request.script_root|tojson|safe }}";
    </script>
</head>

<body data-theme="redteam">
    <header>
        <div class="logo-container">
            <img src="{{ url_for('static', filename='images/panthera_logo.png') }}" alt="Panthera Logo"
                id="pantheraLogo">
            <h1>Panthera Scanner</h1>
        </div>
        <nav class="tabs">
            <button class="tab-link active" onclick="openTab(event, 'ConfigTab')"><i class="fas fa-sliders-h"></i>
                Configuración</button>
            <button class="tab-link" onclick="openTab(event, 'OutputTab')"><i class="fas fa-terminal"></i> Salida del
                Escaneo</button>
            <button class="tab-link" onclick="openTab(event, 'HistoryTab')"><i class="fas fa-history"></i>
                Historial</button>
        </nav>
        <div class="theme-selector-container">
            <label for="themeSwitcher"><i class="fas fa-palette"></i> Tema:</label>
            <select id="themeSwitcher">
                <option value="redteam">Red Team</option>
                <option value="actual">Azul Actual</option>
                <option value="ubuntu">Ubuntu</option>
                <option value="macos">macOS</option>
            </select>
        </div>
    </header>

    <main>
        <div id="ConfigTab" class="tab-content active">
            <section class="config-section targets-section card">
                <h2><i class="fas fa-bullseye"></i> Objetivos del Escaneo</h2>
                <textarea id="targets"
                    placeholder="Introduce un objetivo por línea (ej. example.com, 192.168.1.10)"></textarea>
                <div class="targets-actions">
                    <button id="importTargetsButton" class="button-secondary"><i class="fas fa-file-import"></i>
                        Importar Targets</button>
                    <input type="file" id="importTargetsFile" accept=".txt,.csv" style="display:none;">
                    <button id="clearTargetsButton" class="button-danger-outline"><i class="fas fa-trash"></i>
                        Limpiar</button>
                    <span id="targetsCount" class="targets-count-display">0 objetivo(s)</span>
                </div>
            </section>

            <section class="config-section profiles-section card">
                <h2><i class="fas fa-id-badge"></i> Perfiles de Escaneo</h2>
                <div class="scan-profiles-buttons">
                    <p class="loading-placeholder">Cargando perfiles...</p>
                </div>
            </section>

            <section class="config-section tools-section card">
                <h2><i class="fas fa-tools"></i> Selección de Herramientas</h2>
                <div id="toolList">
                    <p class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Cargando herramientas...</p>
                </div>
            </section>

            <section class="config-section advanced-options-section card">
                <h2><i class="fas fa-cogs"></i> Opciones Avanzadas</h2>
                <div class="options-grid">
                    <div class="option-item">
                        <label for="customScanTime">Timing Nmap (-T):</label>
                        <select id="customScanTime">
                            <option value="">Default (T3/T4)</option>
                            <option value="-T0">T0 (Paranoid)</option>
                            <option value="-T1">T1 (Sneaky)</option>
                            <option value="-T2">T2 (Polite)</option>
                            <option value="-T3">T3 (Normal)</option>
                            <option value="-T4">T4 (Aggressive)</option>
                            <option value="-T5">T5 (Insane)</option>
                        </select>
                    </div>
                    <div class="option-item">
                        <label for="toolTimeout">Timeout por Herramienta (segundos):</label>
                        <input type="number" id="toolTimeout" placeholder="Default (ej. 3600s por herramienta)">
                    </div>
                    <div class="option-item">
                        <label for="scanIntensity">Intensidad del Escaneo (Global):</label>
                        <select id="scanIntensity">
                            <option value="light">Ligero</option>
                            <option value="normal" selected>Normal</option>
                            <option value="deep">Profundo</option>
                        </select>
                    </div>
                    <div class="option-item">
                        <label for="followRedirects">Seguir Redirecciones HTTP:</label>
                        <div>
                            <input type="checkbox" id="followRedirects" checked>
                            <label for="followRedirects"
                                style="font-weight: normal; flex-basis: auto; margin-bottom: 0;">Activado</label>
                        </div>
                    </div>
                </div>
            </section>

            <section class="actions-section" style="text-align: center; margin-top: 2rem;">
                <button id="startScanButton" class="button-primary button-large">
                    <i class="fas fa-bolt"></i> Iniciar Escaneo
                </button>
            </section>
        </div>

        <div id="OutputTab" class="tab-content">
            <div id="job-info-panel" class="card" style="display: none;">
                <h3><i class="fas fa-file-alt"></i> Información del Trabajo Actual</h3>
                <div class="job-info-grid">
                    <p><strong>ID del Trabajo:</strong> <span id="jobIdDisplay">N/A</span></p>
                    <p><strong>Estado:</strong> <span id="jobStatusBadge" class="status-badge status-unknown">N/A</span>
                    </p>
                </div>
                <div class="progress-section">
                    <p><strong>Progreso General:</strong></p>
                    <div class="progress-bar-wrapper">
                        <div id="overallProgressBar" class="progress-bar" role="progressbar" aria-valuenow="0"
                            aria-valuemin="0" aria-valuemax="100" style="width: 0%;">0%</div>
                    </div>
                </div>
                <div class="job-actions-output">
                    <button id="refreshStatusButton" class="button-secondary"><i class="fas fa-sync-alt"></i> Refrescar
                        Estado</button>
                    <button id="cancelJobButton" class="button-danger" style="display: none;"><i
                            class="fas fa-stop-circle"></i> Cancelar Trabajo</button>
                    <a id="downloadJobZipLink" href="#" class="button-success button-like disabled"
                        style="display: none;" target="_blank" rel="noopener noreferrer"><i
                            class="fas fa-file-archive"></i> Descargar Resultados
                        (ZIP)</a>
                </div>
                <div id="tool-progress-details-container" style="margin-top: 1.5rem;">
                    <h4><i class="fas fa-tasks"></i> Progreso Detallado por Herramienta:</h4>
                    <div id="toolProgressDetails" class="tool-progress-list">
                        <p class="empty-placeholder">No hay detalles de herramientas para mostrar aún.</p>
                    </div>
                </div>
            </div>

            <div id="terminal-panel" class="card terminal-container">
                <div class="terminal-header">
                    <div class="terminal-window-controls">
                        {/* Los botones se insertarán aquí por JS según el tema */}
                    </div>
                    <div class="terminal-title-container">
                        <h3><i class="fas fa-terminal"></i> Salida del Terminal</h3>
                    </div>
                    <div class="terminal-actions">
                        <button id="copyLogButton" class="button-small" title="Copiar Log"><i
                                class="fas fa-copy"></i></button>
                        <button id="downloadLogButton" class="button-small" title="Descargar Log"><i
                                class="fas fa-download"></i></button>
                    </div>
                </div> {/* FIN DE .terminal-header */}

                <div id="scanOutput" class="terminal-output">
                    <p class="log-entry log-type-info"><span class="log-icon"><i
                                class="fas fa-info-circle"></i></span><span class="log-timestamp">[--:--:--]</span>
                        <span class="log-message-content">Esperando inicio de escaneo...</span>
                    </p>
                </div>
            </div>
        </div>

        <div id="HistoryTab" class="tab-content">
            <section id="jobs-history-section" class="card">
                <h2><i class="fas fa-history"></i> Historial de Trabajos</h2>
                <ul id="jobsListArea">
                    <li class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Cargando historial...</li>
                </ul>
            </section>
        </div>
    </main>

    <footer>
        <p>&copy; <span id="currentYear"></span> Panthera Security. Todos los derechos reservados.</p>
    </footer>

    <script>document.getElementById('currentYear').textContent = new Date().getFullYear();</script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const themeSwitcher = document.getElementById('themeSwitcher');
            const body = document.body;
            const terminalHeader = document.querySelector('.terminal-header');
            const terminalWindowControlsContainer = terminalHeader ? terminalHeader.querySelector('.terminal-window-controls') : null;

            const ubuntuControlsHTML = `
                <button class="terminal-control-button terminal-control-close" aria-label="Cerrar" title="Cerrar"></button>
                <button class="terminal-control-button terminal-control-minimize" aria-label="Minimizar" title="Minimizar"></button>
                <button class="terminal-control-button terminal-control-maximize" aria-label="Maximizar" title="Maximizar"></button>
            `;

            const macosControlsHTML = `
                <button class="terminal-control-button terminal-control-close" aria-label="Cerrar" title="Cerrar"></button>
                <button class="terminal-control-button terminal-control-minimize" aria-label="Minimizar" title="Minimizar"></button>
                <button class="terminal-control-button terminal-control-maximize" aria-label="Maximizar" title="Maximizar"></button>
            `;

            function applyTheme(theme) {
                body.dataset.theme = theme;
                localStorage.setItem('selectedPantheraTheme', theme);

                if (terminalWindowControlsContainer) {
                    terminalWindowControlsContainer.innerHTML = '';
                    if (theme === 'ubuntu') {
                        terminalWindowControlsContainer.innerHTML = ubuntuControlsHTML;
                    } else if (theme === 'macos') {
                        terminalWindowControlsContainer.innerHTML = macosControlsHTML;
                    }
                }

                let primaryColorVarName = `--primary-color-${theme}`;
                if (theme === 'actual') primaryColorVarName = '--primary-color';
                else if (theme === 'redteam' && !getComputedStyle(document.documentElement).getPropertyValue(primaryColorVarName).trim()) {
                    primaryColorVarName = '--primary-color';
                }

                let primaryColorValue = getComputedStyle(document.documentElement).getPropertyValue(primaryColorVarName).trim();

                if (!primaryColorValue) {
                    const rootPrimaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
                    if (rootPrimaryColor) {
                        primaryColorValue = rootPrimaryColor;
                    } else {
                        primaryColorValue = getComputedStyle(document.documentElement).getPropertyValue('--primary-color-redteam').trim();
                    }
                }

                const rgb = hexToRgb(primaryColorValue);
                if (rgb) {
                    document.documentElement.style.setProperty('--rgb-primary-color', `${rgb.r}, ${rgb.g}, ${rgb.b}`);
                } else {
                    console.warn(`No se pudo convertir ${primaryColorValue} (variable: ${primaryColorVarName}) a RGB para el tema ${theme}. Usando fallback.`);
                    document.documentElement.style.setProperty('--rgb-primary-color', '229, 57, 53');
                }
            }

            function hexToRgb(hex) {
                if (!hex || typeof hex !== 'string') return null;
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            }

            if (themeSwitcher) {
                const savedTheme = localStorage.getItem('selectedPantheraTheme') || 'redteam';
                themeSwitcher.value = savedTheme;
                applyTheme(savedTheme);

                themeSwitcher.addEventListener('change', (event) => {
                    applyTheme(event.target.value);
                });
            } else {
                applyTheme(body.dataset.theme || 'redteam');
            }
        });
    </script>
    <script src="{{ url_for('static', filename='js/scanner_logic.js') }}"></script>
</body>

</html>