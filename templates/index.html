<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panthera Strike - Web Scanner</title>
    <style>
        @import url('https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700');

        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: #0a0a0a;
            color: #ffffff;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            background-color: #1a1a1a;
            border: 1px solid #ff0000;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 15px #ff0000;
            width: 80%;
            max-width: 1000px; /* Aumentado para m√°s contenido */
        }

        h1 {
            text-align: center;
            color: #ffffff;
            text-shadow: 0 0 5px #ff0000;
            margin-bottom: 20px;
        }

        textarea {
            width: calc(100% - 22px);
            height: 100px; /* Reducido un poco */
            background-color: #000;
            color: #ffffff;
            border: 1px solid #ff0000;
            padding: 10px;
            margin-bottom: 10px;
            font-family: inherit;
        }

        button, .button-like {
            background-color: #330000;
            color: #ffffff;
            border: 1px solid #ff0000;
            padding: 10px 15px; /* Ajustado */
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9em; /* Ajustado */
            transition: background-color 0.3s, box-shadow 0.3s;
            margin: 5px; /* A√±adido margen */
            text-decoration: none; /* Para button-like */
            display: inline-block; /* Para button-like */
        }

        button:hover, .button-like:hover {
            background-color: #660000;
            box-shadow: 0 0 10px #ff0000;
        }
        
        .terminal-container {
            margin-top: 20px;
        }

        .terminal {
            width: 100%;
            background: #1e1e1e;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            font-family: 'Ubuntu Mono', 'Courier New', Courier, monospace;
            border: 1px solid #444;
            min-height: 200px;
        }

        .terminal__bar {
            display: flex;
            align-items: center;
            padding: 0 12px;
            height: 32px;
            background: linear-gradient(to bottom, #3c3b37, #2e2d2a);
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            box-shadow: inset 0 -1px 0 rgba(255, 255, 255, 0.05);
            flex-shrink: 0;
        }

        .terminal__buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .terminal__button {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(to bottom, #7d7871, #595953);
            box-shadow: 0 0 1px #41403A, 0 1px 1px #474642;
            padding: 0;
            flex-shrink: 0;
            cursor: default;
            outline: none;
        }

        .terminal__button--exit { background: linear-gradient(to bottom, #ff5f56, #e0443e); }
        .terminal__button--min { background: linear-gradient(to bottom, #ffbd2e, #dea123); }
        .terminal__button--max { background: linear-gradient(to bottom, #27c93f, #12ac28); }

        .terminal__user { margin-left: auto; padding-right: 10px; font-size: 13px; color: #d5d0ce; font-weight: 500; }
        .terminal__body {
            flex-grow: 1;
            background: rgba(0, 0, 0, 0.93);
            padding: 16px;
            color: #e0e0e0;
            font-size: 1em;
            overflow-y: auto;
            max-height: 300px; /* Ajustado */
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .terminal__body .log-entry { margin-bottom: 5px; border-bottom: 1px dashed #333; padding-bottom: 5px; line-height: 1.4; }
        .terminal__body .log-entry:last-child { border-bottom: none; }
        .terminal__body .error { color: #ff5f56; }
        .terminal__body .warn { color: #ffe066; }
        .terminal__body .info { color: #7eda28; }
        .terminal__body strong { color: #ffffff; font-weight: bold; }

        .tool-selection-container, .advanced-options-container, .jobs-list-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #101010;
            border: 1px solid #cc0000;
            border-radius: 5px;
        }
        .tool-selection-container h3, .advanced-options-container h3, .jobs-list-container h3 {
            margin-top: 0;
            color: #ffffff;
        }

        .pentest-phase {
            margin-bottom: 20px;
            border-left: 3px solid #ff0000;
            padding-left: 10px;
        }
        .pentest-phase-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .pentest-phase-header input[type="checkbox"] {
            margin-right: 10px;
            accent-color: #ff0000;
        }
        .pentest-phase-header h4 {
            color: #dd0000;
            margin: 0;
            font-size: 1.1em;
        }
        .tool-category {
            margin-left: 20px; /* Indent categories */
            margin-bottom: 10px;
        }
        .tool-category-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .tool-category-header input[type="checkbox"] {
            margin-right: 8px;
            accent-color: #ff0000;
        }
        .tool-category-header h5 {
            color: #f05050; /* Lighter red for category */
            margin: 0;
            font-size: 1em;
        }
        .tool-item {
            margin-left: 40px; /* Indent tools */
            margin-bottom: 5px;
        }
        .tool-item label { display: flex; align-items: center; font-size: 0.9em; }
        .tool-item input[type="checkbox"] { margin-right: 8px; accent-color: #ff0000; }
        .tool-description { font-size: 0.8em; color: #aaa; margin-left: 25px; }
        .tool-cli-params input[type="text"] {
            background-color: #000;
            color: #fff;
            border: 1px solid #ff0000;
            padding: 5px;
            margin-left: 5px;
            font-size: 0.9em;
        }

        .scan-profiles button, .preset-buttons button { margin-right: 10px; margin-bottom: 10px; }

        .jobs-list-container ul {
            list-style-type: none;
            padding: 0;
            max-height: 250px; /* Ajustado */
            overflow-y: auto;
        }
        .jobs-list-container li {
            padding: 8px;
            border-bottom: 1px solid #330000;
            cursor: pointer;
            display: flex; /* For layout */
            justify-content: space-between; /* For layout */
            align-items: center; /* For layout */
        }
        .jobs-list-container li:hover { background-color: #330000; }
        .jobs-list-container li:last-child { border-bottom: none; }
        .job-actions button, .job-actions a {
            font-size: 0.8em;
            padding: 5px 8px;
            margin-left: 5px;
        }

        .progress-bar-container {
            width: 100%;
            background-color: #333;
            border-radius: 5px;
            margin: 5px 0;
            height: 20px;
            position: relative;
        }
        .progress-bar {
            width: 0%; /* Actual progress */
            height: 100%;
            background-color: #ff0000;
            border-radius: 5px;
            text-align: center;
            line-height: 20px;
            color: white;
            font-size: 0.8em;
            transition: width 0.5s ease-in-out;
        }
        .progress-bar-nessus-like {
            display: flex;
            height: 10px;
            border-radius: 3px;
            overflow: hidden;            
        }
        .progress-segment {
            height: 100%;
            transition: width 0.3s ease;
        }
        .progress-critical { background-color: #dc3545; }
        .progress-high { background-color: #fd7e14; }
        .progress-medium { background-color: #ffc107; }
        .progress-low { background-color: #28a745; }
        .progress-info { background-color: #17a2b8; }

        .advanced-options-container details {
            border: 1px solid #440000;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .advanced-options-container summary {
            cursor: pointer;
            font-weight: bold;
            color: #ff4444;
        }
        .advanced-options-container label {
            display: block;
            margin-top: 10px;
            margin-bottom: 5px;
            color: #ccc;
        }
        .advanced-options-container input[type="text"],
        .advanced-options-container input[type="number"],
        .advanced-options-container select {
            width: calc(100% - 12px);
            padding: 5px;
            background-color: #000;
            color: #fff;
            border: 1px solid #ff0000;
            margin-bottom: 10px;
        }

    </style>
</head>

<body>
    <h1>Panthera Strike - Vulnerability Scanner</h1>
    <div class="container">

        <label for="targets">Targets (FQDN, IPv4, IPv6, URL - uno por l√≠nea):</label>
        <textarea id="targets" placeholder="ejemplo.com\n192.168.1.1\nhttps://sitio.seguro"></textarea>

        <div class="scan-profiles">
            <h3>Perfiles de Escaneo</h3>
            <button onclick="applyScanProfile('Light Scan')">üöÄ Light Scan</button>
            <button onclick="applyScanProfile('Deep Scan')">üî¨ Deep Scan</button>
            <button onclick="applyToolPreset('none')">üßπ Desmarcar Todas</button>
        </div>

        <div class="tool-selection-container">
            <h3>Seleccionar Herramientas de Escaneo</h3>
            <div id="toolList">Cargando herramientas...</div>
        </div>

        <div class="advanced-options-container">
            <details>
                <summary>‚öôÔ∏è Opciones Avanzadas de Escaneo</summary>
                <div>
                    <label for="customScanTime">Tiempo de escaneo personalizado (ej: Nmap -T<valor>):</label>
                    <input type="number" id="customScanTime" name="customScanTime" min="0" max="5" placeholder="4 (Agresivo)">
                    
                    <label for="followRedirects">Seguir redirecciones (para herramientas web):</label>
                    <select id="followRedirects" name="followRedirects">
                        <option value="" selected>Por defecto de la herramienta</option>
                        <option value="true">S√≠</option>
                        <option value="false">No</option>
                    </select>

                    <div id="toolSpecificCliParams"></div>
                </div>
            </details>
        </div>

        <button onclick="startScan()" style="font-size: 1.2em; padding: 12px 25px;">‚ö° Iniciar Escaneo ‚ö°</button>

        <div class="jobs-list-container">
            <h3>Historial de Trabajos</h3>
            <ul id="jobsListArea">
                <li>Cargando trabajos anteriores...</li>
            </ul>
        </div>

        <div id="currentJobInfo" class="job-info" style="display:none; padding: 15px; margin-top:15px; border: 1px solid #ff0000;">
            <h3>Informaci√≥n del Trabajo Actual: <span id="jobIdDisplay" style="color:#ffcc00;"></span></h3>
            <p><strong>Estado:</strong> <span id="jobStatusDisplay" style="font-weight:bold;"></span></p>
            <div id="overallProgressBarContainer" class="progress-bar-container" style="height: 25px; margin-bottom:10px;">
                 <div id="overallProgressBar" class="progress-bar" style="height: 25px; line-height:25px;">0%</div>
            </div>
            <!-- Conceptual Nessus-like progress per target -->
            <div id="targetProgressArea"></div>

            <p>
                <button onclick="refreshStatus()">üîÑ Actualizar Estado</button>
                <button id="cancelJobButton" onclick="cancelScan()" style="background-color:#cc0000; color:white; display:none;">
                    üõë Cancelar Escaneo
                </button>
                <a id="downloadJobZip" class="button-like" href="#" target="_blank" style="background-color:#006600;color:white; display:none;">üíæ Descargar ZIP</a>
            </p>
        </div>

        <h2>Estado/Logs del Escaneo:</h2>
        <div class="terminal-container">
            <div class="terminal">
                <div class="terminal__bar">
                    <div class="terminal__buttons">
                        <button class="terminal__button terminal__button--exit"></button>
                        <button class="terminal__button terminal__button--min"></button>
                        <button class="terminal__button terminal__button--max"></button>
                    </div>
                    <div class="terminal__user">user@panthera</div>
                </div>
                <div id="scanOutput" class="terminal__body">
                    Bienvenido a Panthera Strike. Seleccione sus objetivos y herramientas, luego inicie el escaneo.
                </div>
            </div>
        </div>

    </div> <!-- Cierre de .container -->

    <script>
        const toolListDiv = document.getElementById('toolList');
        const scanOutput = document.getElementById('scanOutput');
        const targetsTextarea = document.getElementById('targets');
        const jobIdDisplay = document.getElementById('jobIdDisplay');
        const jobStatusDisplay = document.getElementById('jobStatusDisplay');
        const overallProgressBar = document.getElementById('overallProgressBar');
        const overallProgressBarContainer = document.getElementById('overallProgressBarContainer');
        const currentJobInfoDiv = document.getElementById('currentJobInfo');
        const cancelJobButton = document.getElementById('cancelJobButton');
        const downloadJobZipLink = document.getElementById('downloadJobZip');
        const jobsListArea = document.getElementById('jobsListArea');
        const toolSpecificCliParamsDiv = document.getElementById('toolSpecificCliParams');

        // Definici√≥n de Herramientas y Perfiles (Ejemplo)

        function applyScanProfile(profileName) {
            const profile = scanProfiles[profileName];
            if (profile) {
                // Clear all tool selections
                document.querySelectorAll('.tool-item-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });

                // Select tools from profile
                profile.tools.forEach(toolName => {
                    const toolCheckbox = document.querySelector(`input[value="${toolName}"]`);
                    if (toolCheckbox) {
                        toolCheckbox.checked = true;
                    }
                });

                // Apply parameters
                for (const [toolName, params] of Object.entries(profile.params)) {
                    const inputField = document.querySelector(`input[name="cli_params_${toolName}"]`);
                    if (inputField) {
                        inputField.value = params;
                    }
                }
            }
        }

        function applyToolPreset(presetName) {
            if (presetName === 'none') {
                // Clear all tool selections
                document.querySelectorAll('.tool-item-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
            }
        }
        const toolsData = {
            "Reconocimiento": {
                "Recopilaci√≥n de Informaci√≥n Pasiva": {
                    "theHarvester": { description: "Recopila emails, subdominios, hosts, etc.", cli_param_placeholder: "-d example.com -l 500 -b google"},
                    "Photon": { description: "Crawler OSINT r√°pido para extraer URLs, emails, archivos, etc.", cli_param_placeholder: "-u example.com --keys"}
                },
                "Escaneo de Red y Puertos": {
                    "Nmap": { description: "Esc√°ner de puertos y descubridor de redes.", cli_param_placeholder: "-sV -T4"},
                    "Masscan": { description: "Esc√°ner de puertos TCP masivo y r√°pido.", cli_param_placeholder: "-p80,443 --rate 1000"}
                }
            },
            "Identificacion de Vulnerabilidades": {
                "Esc√°neres Web": {
                    "Nikto": { description: "Esc√°ner de vulnerabilidades web.", cli_param_placeholder: "-h example.com"},
                    "Nuclei": { description: "Esc√°ner de vulnerabilidades basado en plantillas.", cli_param_placeholder: "-u example.com -t cves/"}
                },
                "Esc√°neres de Infraestructura": {
                    "OpenVAS/GVM": { description: "Framework de escaneo de vulnerabilidades completo.", cli_param_placeholder: "(Configuraci√≥n v√≠a UI externa)"}
                }
            },
            "Explotaci√≥n": {
                "Frameworks de Explotaci√≥n": {
                    "Metasploit Framework": { description: "Plataforma de explotaci√≥n avanzada.", cli_param_placeholder: "(Uso interactivo o v√≠a msfrpc)"}
                }
            }
        };

        const scanProfiles = {
            "Light Scan": {
                tools: ["Nmap", "Nikto"],
                params: {
                    "Nmap": "-T4 -F", // Fast scan
                    "Nikto": "-h {target}"
                }
            },
            "Deep Scan": {
                tools: ["Nmap", "Masscan", "theHarvester", "Photon", "Nikto", "Nuclei"],
                params: {
                    "Nmap": "-sV -sC -A -T4", // Comprehensive scan
                    "Masscan": "-p1-65535 --rate 1000",
                    "theHarvester": "-d {target} -l 500 -b all",
                    "Photon": "-u {target} --level 3 -t 10",
                    "Nikto": "-h {target} -C all",
                    "Nuclei": "-u {target} -t technologies/,cves/,vulnerabilities/"
                }
            }
        };

        function populateToolSelection() {
            toolListDiv.innerHTML = ''; // Limpiar contenido anterior
            let toolIdCounter = 0;

            for (const phaseName in toolsData) {
                const phaseId = `phase-${toolIdCounter++}`;
                const phaseDiv = document.createElement('div');
                phaseDiv.className = 'pentest-phase';
                phaseDiv.innerHTML = `
                    <div class="pentest-phase-header">
                        <input type="checkbox" id="${phaseId}" onchange="toggleChildrenCheckboxes(this, '.tool-category-checkbox, .tool-item-checkbox')">
                        <h4>${phaseName}</h4>
                    </div>
                `;

                for (const categoryName in toolsData[phaseName]) {
                    const categoryId = `category-${toolIdCounter++}`;
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'tool-category';
                    categoryDiv.innerHTML = `
                        <div class="tool-category-header">
                            <input type="checkbox" id="${categoryId}" class="tool-category-checkbox" data-phase-parent="${phaseId}" onchange="toggleChildrenCheckboxes(this, '.tool-item-checkbox'); updateParentCheckbox('${phaseId}', '.tool-category-checkbox')">
                            <h5>${categoryName}</h5>
                        </div>
                    `;

                    for (const toolName in toolsData[phaseName][categoryName]) {
                        const toolDetails = toolsData[phaseName][categoryName][toolName];
                        const toolItemId = `tool-${toolName.replace(/\s+/g, '-')}-${toolIdCounter++}`;
                        const toolItemDiv = document.createElement('div');
                        toolItemDiv.className = 'tool-item';
                        toolItemDiv.innerHTML = `
                            <label for="${toolItemId}">
                                <input type="checkbox" id="${toolItemId}" name="selected_tools" value="${toolName}" class="tool-item-checkbox" data-category-parent="${categoryId}" onchange="updateParentCheckbox('${categoryId}', '.tool-item-checkbox')">
                                ${toolName}
                            </label>
                            <div class="tool-description">${toolDetails.description}</div>
                            <div class="tool-cli-params">
                                <label for="cli-${toolItemId}">Par√°metros CLI:</label>
                                <input type="text" id="cli-${toolItemId}" name="cli_params_${toolName}" placeholder="${toolDetails.cli_param_placeholder || 'Predeterminados'}">
                            </div>
                        `;
                        categoryDiv.appendChild(toolItemDiv);
                    }
                    phaseDiv.appendChild(categoryDiv);
                }
                toolListDiv.appendChild(phaseDiv);
            }
        }

        function toggleChildrenCheckboxes(parentCheckbox, childrenSelector) {
            const parentContainer = parentCheckbox.closest('.pentest-phase, .tool-category');
            const children = parentContainer.querySelectorAll(childrenSelector + '[data-phase-parent="'+parentCheckbox.id+'"], ' + childrenSelector + '[data-category-parent="'+parentCheckbox.id+'"]');
            children.forEach(child => {
                child.checked = parentCheckbox.checked;
                // Si es un checkbox de categor√≠a, tambi√©n actualiza sus hijos (herramientas)
                if (child.classList.contains('tool-category-checkbox')) {
                    toggleChildrenCheckboxes(child, '.tool-item-checkbox');
                }
            });
            // Si el padre es un checkbox de fase, actualiza sus categor√≠as hijas
            if (parentCheckbox.id.startsWith('phase-')) {
                 const categoryCheckboxes = parentContainer.querySelectorAll('.tool-category-checkbox');
                 categoryCheckboxes.forEach(catChild => {
                    updateParentCheckbox(parentCheckbox.id, '.tool-category-checkbox');
                 });
            }
        }

        function updateParentCheckbox(parentId, childrenSelector) {
            const parentCheckbox = document.getElementById(parentId);
            if (!parentCheckbox) return;

            const parentContainer = parentCheckbox.closest('.pentest-phase, .tool-category');
            if (!parentContainer) return;

            const children = parentContainer.querySelectorAll(childrenSelector + '[data-phase-parent="'+parentId+'"], ' + childrenSelector + '[data-category-parent="'+parentId+'"]');
            const allChecked = Array.from(children).every(child => child.checked);
            const someChecked = Array.from(children).some(child => child.checked);

            parentCheckbox.checked = allChecked;
            parentCheckbox.indeterminate = !allChecked && someChecked;

            // Propagar el cambio hacia arriba (si es una categor√≠a, actualizar su fase padre)
            if (parentCheckbox.dataset.phaseParent) {
                updateParentCheckbox(parentCheckbox.dataset.phaseParent, '.tool-category-checkbox');
            }
        }

        function applyScanProfile(profileName) {
            applyToolPreset('none'); // Primero desmarcar todo
            const profile = scanProfiles[profileName];
            if (profile) {
                profile.tools.forEach(toolName => {
                    const toolCheckbox = document.querySelector(`input[name="selected_tools"][value="${toolName}"]`);
                    if (toolCheckbox) {
                        toolCheckbox.checked = true;
                        // Actualizar padres
                        const categoryParentId = toolCheckbox.dataset.categoryParent;
                        if (categoryParentId) updateParentCheckbox(categoryParentId, '.tool-item-checkbox');
                        
                        // Aplicar par√°metros CLI espec√≠ficos del perfil
                        const cliInput = document.getElementById(`cli-${toolCheckbox.id}`);
                        if (cliInput && profile.params && profile.params[toolName]) {
                            cliInput.value = profile.params[toolName].replace('{target}', 'OBJETIVO_GENERICO'); // Placeholder
                        }
                    }
                });
            }
        }

        function applyToolPreset(presetName) {
            const allToolCheckboxes = document.querySelectorAll('input[name="selected_tools"], .tool-category-checkbox, .pentest-phase input[type="checkbox"]');
            if (presetName === 'none') {
                allToolCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    checkbox.indeterminate = false;
                    // Limpiar par√°metros CLI si se desmarcan todas
                    if (checkbox.name === 'selected_tools') {
                        const cliInput = document.getElementById(`cli-${checkbox.id}`);
                        if (cliInput) cliInput.value = '';
                    }
                });
            }
            // Aqu√≠ se podr√≠an a√±adir m√°s presets si se desea
        }

        async function startScan() {
            const targets = targetsTextarea.value.trim().split('\n').filter(t => t.trim() !== '');
            if (targets.length === 0) {
                logToTerminal("Por favor, ingrese al menos un objetivo.", "error");
                return;
            }

            const selectedTools = Array.from(document.querySelectorAll('input[name="selected_tools"]:checked'))
                                     .map(cb => {
                                         const cliInput = document.getElementById(`cli-${cb.id}`);
                                         return {
                                             name: cb.value,
                                             cli_params: cliInput ? cliInput.value : ''
                                         };
                                     });

            if (selectedTools.length === 0) {
                logToTerminal("Por favor, seleccione al menos una herramienta de escaneo.", "error");
                return;
            }

            // Mostrar comandos completos que se ejecutar√°n
            const commandsInfo = selectedTools.map(tool => {
                const toolName = tool.name;
                const toolCliParams = tool.cli_params.replace('{target}', targets.join(', ')) || 'Predeterminados';
                return `‚Ä¢ ${toolName} ${toolCliParams}`;
            }).join('\n');
            
            logToTerminal(`Iniciando escaneo para objetivo(s): ${targets.join(', ')} con herramientas: ${selectedTools.map(tool => {
                const params = document.getElementById(`cli-tool-${tool.replace(/\\s+/g, '-')}`)?.value || '';
                return `${tool}(${params})`;
            }).join(', ')}`, 'info');
            currentJobInfoDiv.style.display = 'block';
            jobIdDisplay.textContent = 'Generando...';
            jobStatusDisplay.textContent = 'Iniciando...';
            overallProgressBar.style.width = '0%';
            overallProgressBar.textContent = '0%';
            cancelJobButton.style.display = 'inline-block';
            downloadJobZipLink.style.display = 'none';

            // TODO: Implementar la llamada al backend para iniciar el escaneo
            // Ejemplo de c√≥mo podr√≠a ser la llamada:
            try {
                const response = await fetch('/api/scan/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ targets, tools: selectedTools /*, advanced_options */ }),
                });
                
                // Verificar si la respuesta es JSON v√°lido
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    logToTerminal(`Respuesta del servidor no es JSON: ${text.substring(0, 200)}`, 'error');
                    return;
                }
                
                const data = await response.json();
                if (response.ok) {
                    jobIdDisplay.textContent = data.job_id;
                    logToTerminal(`Escaneo iniciado con Job ID: ${data.job_id}`, "info");
                    localStorage.setItem('currentJobId', data.job_id);
                    refreshStatus(data.job_id);
                } else {
                    logToTerminal(`Error al iniciar escaneo (HTTP ${response.status}): ${data.error || 'Error desconocido'}`, "error");
                    currentJobInfoDiv.style.display = 'none';
                }
                
                const responseData = await response.json();
                if (response.ok) {
                    jobIdDisplay.textContent = data.job_id;
                    logToTerminal(`Escaneo iniciado con Job ID: ${data.job_id}`, "info");
                    localStorage.setItem('currentJobId', data.job_id);
                    refreshStatus(data.job_id);
                } else {
                    logToTerminal(`Error al iniciar escaneo: ${data.error || 'Error desconocido'}`, "error");
                    currentJobInfoDiv.style.display = 'none';
                }
            } catch (error) {
                logToTerminal(`Error al iniciar escaneo: ${error.message || error}`, "error");
                currentJobInfoDiv.style.display = 'none';
            }
        }

        function logToTerminal(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            
            // Mejorar formato de mensajes de error
            let formattedMessage = message;
            if (type === 'error') {
                formattedMessage = `‚ùå ERROR: ${message}`;
            } else if (type === 'warn') {
                formattedMessage = `‚ö†Ô∏è WARNING: ${message}`;
            } else if (type === 'info') {
                formattedMessage = `‚ÑπÔ∏è INFO: ${message}`;
            } else if (type === 'command') {
                formattedMessage = `üõ†Ô∏è COMMAND: ${message}`;
            } else if (type === 'command') {
                formattedMessage = `üõ†Ô∏è COMMAND: ${message}`;
            }
            
            entry.innerHTML = `<strong>[${timestamp}]</strong> ${formattedMessage.replace(/\n/g, '<br>')}`;
            scanOutput.appendChild(entry);
            scanOutput.scrollTop = scanOutput.scrollHeight; // Auto-scroll
        }

        async function refreshStatus(jobId = null) {
            const currentJobId = jobId || localStorage.getItem('currentJobId');
            if (!currentJobId) {
                // logToTerminal("No hay un trabajo activo para actualizar.", "warn");
                currentJobInfoDiv.style.display = 'none';
                return;
            }

            jobIdDisplay.textContent = currentJobId;
            currentJobInfoDiv.style.display = 'block';
            cancelJobButton.style.display = 'inline-block'; // Mostrar siempre si hay job ID

            // TODO: Implementar la llamada al backend para obtener el estado del trabajo
            try {
                const response = await fetch(`/api/scan/status/${currentJobId}`);
                const data = await response.json();

                if (response.ok) {
                    jobStatusDisplay.textContent = data.status;
                    overallProgressBar.style.width = `${data.overall_progress || 0}%`;
                    overallProgressBar.textContent = `${data.overall_progress || 0}%`;

                    if (data.logs && data.logs.length > 0) {
                        data.logs.forEach(log => logToTerminal(log.message, log.type));
                    }

                    if (data.status === 'COMPLETED' || data.status === 'CANCELLED' || data.status === 'ERROR') {
                        cancelJobButton.style.display = 'none';
                        if (data.zip_path) {
                            downloadJobZipLink.href = data.zip_path;
                            downloadJobZipLink.style.display = 'inline-block';
                        }
                        localStorage.removeItem('currentJobId');
                        // Podr√≠amos dejar de hacer polling aqu√≠
                    } else {
                        // Continuar actualizando si est√° en progreso
                        setTimeout(() => refreshStatus(currentJobId), 5000); // Poll cada 5 segundos
                    }
                } else {
                    logToTerminal(`Error al obtener estado: ${data.error || 'Error desconocido'}`, "error");
                    if (response.status === 404) { // Job no encontrado, quiz√°s ya no existe
                        localStorage.removeItem('currentJobId');
                        currentJobInfoDiv.style.display = 'none';
                    }
                }
            } catch (error) {
                logToTerminal(`Error de red al obtener estado: ${error}`, "error");
            }
        }

        async function cancelScan() {
            const currentJobId = localStorage.getItem('currentJobId');
            if (!currentJobId) {
                logToTerminal("No hay un trabajo activo para cancelar.", "warn");
                return;
            }
            if (!confirm(`¬øEst√° seguro de que desea cancelar el trabajo ${currentJobId}?`)) {
                return;
            }
            // TODO: Implementar la llamada al backend para cancelar el escaneo
            try {
                const response = await fetch(`/api/scan/cancel/${currentJobId}`, { method: 'POST' });
                const data = await response.json();
                if (response.ok) {
                    logToTerminal(`Solicitud de cancelaci√≥n enviada para el trabajo ${currentJobId}.`, "info");
                    jobStatusDisplay.textContent = "Cancelando...";
                    cancelJobButton.style.display = 'none';
                } else {
                    logToTerminal(`Error al cancelar escaneo: ${data.error || 'Error desconocido'}`, "error");
                }
            } catch (error) {
                logToTerminal(`Error de red al cancelar escaneo: ${error}`, "error");
            }
        }

        async function loadJobs() {
            jobsListArea.innerHTML = '<li>Cargando trabajos...</li>';
            // TODO: Implementar la llamada al backend para cargar el historial de trabajos
            try {
                const response = await fetch('/api/jobs');
                const jobs = await response.json();
                jobsListArea.innerHTML = ''; // Limpiar
                if (jobs.length === 0) {
                    jobsListArea.innerHTML = '<li>No hay trabajos anteriores.</li>';
                    return;
                }
                jobs.forEach(job => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span><strong>ID:</strong> ${job.id} (${job.status}) - ${new Date(job.timestamp).toLocaleString()}</span>
                        <div class="job-actions">
                            <button onclick="viewJobDetails('${job.id}')">Ver Detalles</button>
                            ${job.zip_path ? `<a href="${job.zip_path}" class="button-like" target="_blank">Descargar</a>` : ''}
                        </div>
                    `;
                    li.onclick = () => viewJobDetails(job.id); // Cargar detalles al hacer clic
                    jobsListArea.appendChild(li);
                });
            } catch (error) {
                logToTerminal(`Error al cargar historial de trabajos: ${error}`, "error");
                jobsListArea.innerHTML = '<li>Error al cargar trabajos.</li>';
            }
        }

        function viewJobDetails(jobId) {
            logToTerminal(`Cargando detalles para el trabajo ${jobId}...`, "info");
            localStorage.setItem('currentJobId', jobId);
            refreshStatus(jobId);
            // Idealmente, esto tambi√©n podr√≠a cargar logs espec√≠ficos del trabajo si no est√°n ya en la terminal principal
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            populateToolSelection();
            loadJobs();
            const lastJobId = localStorage.getItem('currentJobId');
            if (lastJobId) {
                refreshStatus(lastJobId); // Intenta recargar el estado del √∫ltimo trabajo activo
            }
        });

    </script>
</body>

</html>